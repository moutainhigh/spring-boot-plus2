<!DOCTYPE html>
<html xmlns:th="http://www.springframework.org/schema/data/jaxb">
<head>
    <meta charset="utf-8">
    <title>开发任务</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="/components/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/components/layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="/base/css/search.css" media="all">
    <script src="/components/layuiadmin/layui/layui.js"></script>
    <script src='/base/js/jquery-3.4.1.js'></script>
    <script src="/base/js/app.js"></script>
</head>
<body>
<style>
    .layui-inline {
        width: 210px;
    }

    .layui-input-block {
        width: 140px;
    }
</style>
<!-- 搜索 -->
<div class="searchTable layui-form">
    <div class="layui-inline">
        <label class="layui-form-label">项目:</label>
        <div class="layui-input-block">
            <select id="item" name="item">
                <option value="" selected="">所有</option>
            </select>
        </div>
    </div>

    <div class="layui-inline">
        <label class="layui-form-label">执行人:</label>
        <div class="layui-input-block">
            <select id="taskUserId" name="taskUserId">
                <option value="" selected="">全部</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">状态:</label>
        <div class="layui-input-block">
            <select id="state" name="state">
                <option value="" selected="">全部</option>
                <option value="0">未开始</option>
                <option value="1">正在进行</option>
                <option value="2">已完成</option>
                <option value="3">已撤销</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">类型:</label>
        <div class="layui-input-block">
            <select id="type" name="type">
                <option value="" selected="">全部</option>
                <option value="1">管理端</option>
                <option value="2">用户端</option>
                <option value="3">app端</option>
                <option value="4">多端</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">任务名:</label>
        <div class="layui-input-block">
            <input type="text" id="name" name="name" placeholder="请输入任务名..." autocomplete="off" class="layui-input">
        </div>
    </div>
    <!-- <button class="layui-btn layui-btn-normal layui-btn-sm" data-type="reload">搜索</button>-->
    <div class="layui-inline">
        <button class="layui-btn layui-btn-normal layui-btn-sm" data-type="reload" style="margin-bottom: 8px;margin-left: 20%">
            <i class="layui-icon layui-icon-search  layuiadmin-button-btn"></i>
        </button>
    </div>
</div>
<!-- 表格 -->
<table class="auth-table" id="auth-table" lay-filter="auth-table"></table>
<!-- 分页插件 -->
<div class="page-table" id="page-table"></div>
<!-- 多删除-添加  -->
<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
    </div>
</script>
<!-- 每一行的数据修改或删除  -->
<script type="text/html" id="barDemo">
    {{#  if(d.state ==0){ }}
    <a class="layui-btn  layui-btn-primary layui-btn-xs" lay-event="startBug">开始</a>
    <a class="layui-btn  layui-btn-warm layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    {{# }if(d.state ==1) { }}
    <a class="layui-btn  layui-btn-primary layui-btn-xs" lay-event="entBug">完成</a>
    <a class="layui-btn  layui-btn-warm layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn  layui-btn-primary layui-btn-xs" lay-event="rollback">取消开始</a>
    {{# }if(d.state ==2) { }}
    <a class="layui-btn  layui-btn-primary layui-btn-xs" lay-event="undo">撤销</a>
    {{# }if(d.state ==3) { }}
    <a class="layui-btn  layui-btn-primary layui-btn-xs" lay-event="startBug">开始</a>
    <a class="layui-btn  layui-btn-warm layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    {{#  } }}
</script>
<script>

    let find_page = path + "/dev/devBug/findPage";       // 查询-分页
    let del = path + "/dev/devBug/del";                  // 角色删除
    let updState = path + "/dev/devBug/updByState";      // 编辑状态
    //
    let page_add = path + "/page/modules_dev_devBug_devBugAdd";   //角色添加弹出
    let page_upd = path + "/page/modules_dev_devBug_devBugUpd";   //角色编辑弹出


    let dev_user_list = "/admin/adminUser/findByRoleId?roleId=" + BaseConfig.dev_user_role_id;  // 查询开发人员(角色)（注意数据库参数是否正确）
    let item_list = "/admin/adminDictionary/findByCode?code=" + Enums.Dev.BaseItem;             // 查询字典项目列表（注意数据库参数是否正确）
    var usersData = Ajax.get(dev_user_list);
    var itemsData = Ajax.get(item_list);


    let table;     // 数据表格组件
    let laypage;   // 分页组件
    let res;       // 完整的后台数据
    var data;      // 当前行数据（弹出层时可直接parent.data获取）
    layui.use(['table', 'laypage'], function () {
        table = layui.table;
        laypage = layui.laypage;
        xijiaRenderTable(null);    //  数据表格 - 获取表格
        xijiaLayPage();            //  分页插件
        xijiaEventToolbar();       //  工具栏事件（多删除/添加）
        xijiaEventTool();          //  监听数据表格内按钮操作（编辑,删除等）
        xijiaEventSearch();        //  监听条件搜索
    });

    /**
     *  重载表格和加载表格
     * ---- getPage()= 获取 layui 当前分页参数 ===> 如：?current=1&size=10
     * ---- res = 后台返回的整个数据，整个页面可获取使用
     * @param params get请求的参数拼接
     *
     */
    function xijiaRenderTable(params) {
        if (params === null || params === "null" || params === undefined || params === "undefined") {
            params = "";
        }
        res = Ajax.get(find_page + getPage() + params);
        table.render({
            elem: '#auth-table'
            , data: res.data.records
            , toolbar: '#toolbarDemo'
            , title: 'bug修复'
            , limit: res.data.size
            , cols: [
                [
                    // {type: 'checkbox', fixed: 'left'}   //fixed: 'right', , fixed: 'left'

                    /*      {field: 'id', title: 'ID'},
                          {field: 'createTime', title: '创建时间'},
                          {field: 'updateTime', title: '最后更新时间'},
                          {field: 'deleted', title: '逻辑删除（0：正常  1：删除）'},
                          {field: 'createUserId', title: '创建人id (保留)'},
                          {field: 'BugUserId', title: '指派给id（保留）'},*/
                    {field: 'id', title: 'ID', width: 75},

                    {
                        field: 'itemName', title: '项目名', width: 120, templet: function (res) {
                            for (let i = 0; i < itemsData.data.dictList.length; i++) {
                                if (res.item === itemsData.data.dictList[i].code) {
                                    return itemsData.data.dictList[i].name;
                                }
                            }
                        }
                    },
                    {
                        field: 'type', title: '类型', width: 100, templet: function (res) {
                            return res.type === 1 ? '管理端' : res.type === 2 ? '用户端' : res.type === 3 ? 'app端' : res.type === 4 ? '多端' : '未知';
                        }
                    },
                    {
                        field: 'taskUserName', title: '指派人', width: 100, templet: function (res) {
                            for (let i = 0; i < usersData.data.length; i++) {
                                if (res.taskUserId === usersData.data[i].id) {
                                    return usersData.data[i].fullName;
                                }
                            }
                        }
                    },
                    {field: 'name', title: 'BUG名称', width: 180},
                    {field: 'content', title: 'BUG内容', width: 360},

                    {
                        field: 'state', title: 'BUG状态', width: 100, templet: function (res) {
                            return res.state === 0 ? ' <font color="red">未开始</font>' : res.state === 1 ? '<font color="#ff00ff">正在进行</font>' : res.state === 2 ? '<font color="green">已完成</font>' : res.state === 3 ? '已撤销' : '未知';
                        }
                    },

                    {field: 'plannedTime', title: '预计完成时间', width: 160, sort: false},
                    {field: 'entTime', title: '实际完成时间', width: 160, sort: true},
                    {field: 'estimateTime', title: '预耗时', width: 80},
                    {field: 'takeUpTime', title: '耗时S', width: 80},
                    {title: '操作', toolbar: '#barDemo', width: 250}
                ]
            ]
        });
    }


    /**
     *   分页配置, 数据总数会在下一次点击事更新上一次数据库的总数量
     * @author ws
     * @mail  1720696548@qq.com
     * @param result 后台返回数据, 用于第一此加载总数据
     * @date  2020/4/22 0022 1:18
     * @return
     */
    function xijiaLayPage() {
        laypage.render({
            // 注意，这里的 page-table 是 ID，不用加 # 号
            elem: 'page-table'
            , count: res.data.total    // 数据总数，从服务端得到
            , limit: res.data.size     // 每页数量
            // 基础信息配置
            , layout: pageJson.layout
            , curr: pageJson.curr
            , limits: pageJson.limits
            , groups: pageJson.groups
            , prev: pageJson.prev
            , next: pageJson.next
            // 监听 obj包含了当前分页的所有参数， 比如： obj.curr =当前页, obj.limit = 每页显示条数
            , jump: function (obj, first) {
                //首次不执行, 第一次加载时 first=true
                if (first) {
                    return;
                }
                // 刷新表格
                xijiaRenderTable(reqParams());
            }
        });
    }


    /**
     *   工具栏事件（多删除 || 添加）  ==>> toolbar(auth-table): toolbar=监听表格头事件,  auth-table=数据表格elem 名称
     * @author ws
     * @mail  1720696548@qq.com
     * @param null
     * @date  2020/4/10 0010 0:05
     * @return
     */
    function xijiaEventToolbar() {
        table.on('toolbar(auth-table)', function (obj) {
            //添加
            if (obj.event === "add") {
                Pop.tipsWindown(page_add, "640px", "580px", "添加");
            }
        });
    }

    /**
     *   监听数据表格内按钮（编辑 || 删除 || 其他）, tool(auth-table)==> tool =监听按钮， auth-table=数据表格elem对应值
     * @author ws
     * @mail  1720696548@qq.com
     * @param null
     * @date  2020/4/10 0010 0:03
     * @return
     */
    function xijiaEventTool() {
        table.on('tool(auth-table)', function (obj) {
            data = obj.data;  //当前行数据
            // 编辑
            if (obj.event === 'edit') {
                Pop.tipsWindown(page_upd, "640px", "580px", "修改");
            }
            // 删除
            if (obj.event === 'del') {
                let params = "?id=" + data.id;
                Pop.tipsDeleteId(del + params, obj);
            }
            // 开始
            if (obj.event === 'startBug') {
                let params = "?id=" + data.id;
                params += "&state=" + 1;
                Ajax.put(updState + params);
                // 刷新表格
                xijiaRenderTable(reqParams());
            }

            // 完成
            if (obj.event === 'entBug') {
                // prompt层
                layer.prompt({title: '请输入修复该Bug的实际耗时?'}, function (takeUpTime, index) {
                    // 实际耗时
                    let params = "?id=" + data.id;
                    params += "&state=" + 2;
                    params += "&takeUpTime=" + takeUpTime;
                    Ajax.put(updState + params);
                    // 刷新表格
                    xijiaRenderTable(reqParams());
                    layer.close(index);
                });


            }

            // 取消开始
            if (obj.event === 'rollback') {
                let params = "?id=" + data.id;
                params += "&state=" + 0;
                Ajax.put(updState + params);
                // 刷新表格
                xijiaRenderTable(reqParams());
            }
            // 撤销
            if (obj.event === 'undo') {
                let params = "?id=" + data.id;
                params += "&state=" + 3;
                Ajax.put(updState + params);
                // 刷新表格
                xijiaRenderTable(reqParams());
            }
        });
    }


    /**
     *   条件搜索，重载数据
     * @author ws
     * @mail  1720696548@qq.com
     * @date  2020/4/10 0010 0:03
     * @return
     */
    function xijiaEventSearch() {
        let $ = layui.$, active = {
            //搜索
            reload: function () {
                // 重置到第一页
                $(".layui-laypage-skip .layui-input").val(1);
                // 数据表格 - 获取表格
                xijiaRenderTable(reqParams());
                // 刷新分页插件数据
                xijiaLayPage();
            }
        };
        $('.searchTable .layui-btn').on('click', function () {
            let type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    }

    /**
     * 请求参数封装
     */
    function reqParams() {
        let params = "";
        params += "&name=" + $("#name").val();
        params += "&type=" + $("#type").val();
        params += "&state=" + $("#state").val();
        params += "&item=" + $("#item").val();
        params += "&taskUserId=" + $("#taskUserId").val();
        return params;
    }

    //初始化数据
    $(function () {
        // 开发人员select
        let userListHtml = "<option value=\"\" selected=\"\">全部</option>";
        for (let i = 0; i < usersData.data.length; i++) {
            userListHtml += "<option value='" + usersData.data[i].id + "' >" + usersData.data[i].fullName + "</option>"
        }
        //项目select
        let itemListHtml = "<option value=\"\" selected=\"\">全部</option>";
        for (let i = 0; i < itemsData.data.dictList.length; i++) {
            itemListHtml += "<option value='" + itemsData.data.dictList[i].code + "' >" + itemsData.data.dictList[i].name + "</option>"
        }
        $("#taskUserId").html(userListHtml);
        $("#item").html(itemListHtml)
    });

</script>
</body>
</html>