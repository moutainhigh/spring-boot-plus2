<!DOCTYPE html>
<html xmlns:th="http://www.springframework.org/schema/jdbc">
<head>
    <meta charset="utf-8">
    <title>树组件</title>
    <!--    <link rel="stylesheet" th:href="@{/layuiadmin/layui/css/layui.css}" media="all">-->
    <!--    <script th:src="@{/layuiadmin/layui/layui.js}"></script>-->

    <link rel="stylesheet" th:href="@{/treetable-lay/assets/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/treetable-lay/assets/common.css}"/>
    <script language=javascript th:src='@{/treetable-lay/assets/layui/layui.js}'></script>
    <script language=javascript th:src='@{/js/jquery-3.4.1.js}'></script>
    <script th:src="@{/js/app.js}"></script>
</head>
<body>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>角色菜单权限分配</legend>
</fieldset>

<!-- 左边树 -->
<div style="display: inline-block;float:left; width: 20%; height: 400px; padding: 10px; border: 1px solid #ddd; overflow: auto;margin-top: 1.6%">
    <ul id="demo1"></ul>
</div>


<!-- 菜单树，数据表格-->
<div style="float:left; margin-left: 5%">

    <div class="layui-tab layui-tab-brief" lay-filter="tab">
        <ul id="tabRoot1" class="layui-tab-title">
            <li class="layui-this" lay-id="1">网站设置</li>
            <li lay-id="2">用户管理</li>
            <li>权限分配</li>
            <li>商品管理</li>
            <li>订单管理</li>
        </ul>
        <div class="layui-tab-content" style="height: 100px;">
            <table id="auth-table" class="layui-table" lay-filter="auth-table"></table>
        </div>
    </div>
</div>


<script>

    $(function () {
        //动态加载tab标签
        tabRoot1();
    });


    var menuFindAll = ADMIN_PATH + "/menuAdmin/findAll/1";    //根据父节点查询所有改父节点下的数据列表
    var menuFindIdAll = ADMIN_PATH + "/menuAdmin/findAll/2";    //根据父节点查询所有改父节点下的数据列表
    var menuRole = ADMIN_PATH + "/roleAdmin/findAll/2";       //角色查询-所有
    // 获得角色列表
    let rolesJson = ajaxGet(menuRole);
    // 获得菜单数据
    var dataJson = ajaxGet(menuFindAll);


    // 系统级菜单加载到Tab标签  -->  root=1
    function tabRoot1() {
        let html = "<li   class='layui-this' lay-id=" + -1 + ">" + "所有" + "</li>";
        $.each(dataJson, function (index) {
            if (dataJson[index].root === 1) {
                if (html === "") {
                    html += "<li   class='layui-this' lay-id=" + dataJson[index].id + ">" + dataJson[index].name + "</li>";
                } else {
                    html += "<li  lay-id=" + dataJson[index].id + ">" + dataJson[index].name + "</li>";
                }
            }
        });
        $("#tabRoot1").html(html);
    }



    /**
     * 右边列表数据
     */
    layui.config({
        base: '../treetable-lay/module/' //静态资源所在路径
    }).extend({
        treetable: 'treetable-lay/treetable'
    }).use(['table', 'treetable', 'element','tree'], function () {
        var $ = layui.jquery
            , table = layui.table
            , tree = layui.tree
            , treetable = layui.treetable
            , element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块

        layui.tree({
            elem: '#demo1' //指定元素
            , target: '_blank' //是否新选项卡打开（比如节点返回href才有效）
            , click: function (item) { //点击节点回调
                clickRole(treetable,item);
            }
            , nodes: [ //节点
                {
                    name: '角色列表'
                    , id: 0
                    , spread: true
                    , children: rolesJson.data  //角色数据
                }
            ]
        });
        //生成一个模拟树
        var createTree = function (node, start) {
            node = node || function () {
                var arr = [];
                for (var i = 1; i < 10; i++) {
                    arr.push({
                        name: i.toString().replace(/(\d)/, '$1$1$1$1$1$1$1$1$1')
                    });
                }
                return arr;
            }();
            start = start || 1;
            layui.each(node, function (index, item) {
                if (start < 10 && index < 9) {
                    var child = [
                        {
                            name: (1 + index + start).toString().replace(/(\d)/, '$1$1$1$1$1$1$1$1$1')
                        }
                    ];
                    node[index].children = child;
                    createTree(child, index + start + 1);
                }
            });
            return node;
        };

        //初始化table数据
        tableRender(treetable,dataJson);
        /**
         * 监听 tab 选项卡重载table数据
         * @type {{tabDelete: tabDelete, tabChange: tabChange, tabAdd: tabAdd}}
         */
        element.on('tab(tab)', function (elem) {
            let pid = $(this).attr('lay-id');
            var url = "";
            url += "&&id=" + pid;
            url += "&&roleId="+ roleId;
            if(pid === '-1'){
                // 获得菜单数据
                var  dataJson = ajaxGet(menuFindAll+"?1+1"+ url);
                tableRender(treetable,dataJson)
            }else{
                var  dataJson = ajaxGet(menuFindIdAll+"?1+1"+ url);
                tableRender(treetable,dataJson)
            }
        });
    });
    //保存上次选中的角色
    var roleId = 0;
    /**
     * 左列表监听重载table数据
     */
    function clickRole(treeTable,item){
        let pid = $(".layui-this").attr("lay-id");
        var url = "";
        url += "&&id=" + pid;
        url += "&&roleId="+ item.id;
        if(pid === '-1'){
            // 获得菜单数据
            var dataJson = ajaxGet(menuFindAll+"?1+1"+ url);
            tableRender(treeTable,dataJson);
        }else{
            var dataJson = ajaxGet(menuFindIdAll+"?1+1"+ url);
            tableRender(treeTable,dataJson);
        }
        roleId = pid;
        // layer.msg(item.id + "==" + item.name+ "==" +pid);
    }


    /**
     * 重载table数据
     * @param treetable
     * @param dataJson
     */
    function tableRender(treetable,dataJson){
        // 渲染表格
        layer.load(2);
        treetable.render({
            treeColIndex: 1,            //菜单列索引 ,加载展开图标
            treeSpid: 0,                //顶级父id
            treeIdName: 'id',           //id 名称
            treePidName: 'pid',         //fid 名称
            treeDefaultClose: false,     // 是否默认折叠
            treeLinkage: false,         // 父级展开时是否自动展开所有子级
            elem: '#auth-table',        //table 的 div
            // url:'/menu/findAll',                         //后台接口获取数据
            //url: '../treetable-lay/json/menus.json',     //json文件获取数据
            data: dataJson,                                //直接加载数据

            page: false,
            done: function () {
                //  $("table").css("width", "96%");
                layer.closeAll('loading');
            },
            cols: [
                [
                    {type: 'checkbox'},
                    // {field: 'id', width: 80, type: 'id', title: 'id'},
                    {field: 'name', width: 300, title: '菜单列表'},//edit: 'text',
                    // {field: 'sort', width: 150, edit: 'text', title: '排序'},
                    {field: 'icon', width: 300, edit: 'text', title: '图标'},
                    {field: 'url', width: 300, title: '菜单url'}
                    // {field: 'authority', width: 110, edit: 'text', title: '权限id'}
                ]
            ]
        });
    }
</script>

</body>
</html>
